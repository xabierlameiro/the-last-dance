// Usage: `node custom-reporter.js`
import { readFile, writeFile } from 'fs';
import glob from 'glob';

glob('public/coverage/**/*.?(html|css)', (globErr, files) => {
    if (globErr) {
        console.error('err', globErr);
        throw new Error('Failed to glob files');
    }

    files.forEach((path) => {
        readFile(path, 'utf8', (readErr, data) => {
            if (readErr) {
                console.error('err', readErr);
                throw new Error('Failed to read file');
            }
            let replaced = data.replace(
                /Code coverage generated by\n\s*<a href="https:\/\/istanbul\.js\.org\/" target="_blank" rel="noopener noreferrer">istanbul<\/a>\n\s*(.*)\n\s*<\/div>/g,
                `Code coverage automatically generated by Xabier Lameiro on ${new Date().toLocaleString()}`
            );

            replaced = replaced.replace(
                /<div class='pad1'>\n\s*<h1>(.*)All files/g,
                "<div class='pad1'><h1><a href='/'>Return</a></h1></h1><h1><a href='/'>All tests</a>"
            );

            replaced = replaced.replace(/<title>(.*)<\/title>/, '<title>Code coverage by Xabier Lameiro</title>');

            replaced = replaced.replace(
                /(.*)<link rel="shortcut icon" (.*)\s* href="(.*)" \/>/,
                '<link rel="shortcut icon" type="image/x-icon" href="https://pre.xabierlameiro.com/favicon.png">'
            );

            replaced = replaced.replace(
                /\.pad1 { padding: 10px; }/,
                '.pad1 { padding: 10px; width: 100%; overflow: scroll; }'
            );

            writeFile(path, replaced, 'utf-8', (writeErr) => {
                if (writeErr) {
                    console.error('err', writeErr);
                    throw new Error('Failed to write file');
                }
            });
        });
    });

    readFile('public/favicon.png', 'utf8', (faviconReadErr, data) => {
        if (faviconReadErr) {
            console.error('err', faviconReadErr);
            throw new Error('Failed to read favicon');
        }
        writeFile('public/coverage/favicon.png', data, 'utf-8', (faviconWriteErr) => {
            if (faviconWriteErr) {
                console.error('err', faviconWriteErr);
                throw new Error('Failed to write favicon');
            }
        });
    });
});
